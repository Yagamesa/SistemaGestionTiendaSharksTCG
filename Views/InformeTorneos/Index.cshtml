@model ProyectoMDGSharksWeb.Models.InformeTorneosViewModel
@using System.Text.Json

@{
    ViewData["Title"] = "Informe Torneos y Clientes";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var fechaDesde = ViewData["FechaDesde"] as string ?? "";
    var fechaHasta = ViewData["FechaHasta"] as string ?? "";
}

<style>
    .informe-container {
        background-color: #f8f9fa;
        border-radius: 20px;
        padding: 30px;
        max-width: 1200px;
        margin: auto;
    }

    .export-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-bottom: 20px;
    }

    .btn-export {
        font-size: 0.8rem;
        padding: 6px 12px;
        border-radius: 5px;
        color: white;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .btn-export-pdf {
        background-color: #dc3545;
    }

        .btn-export-pdf:hover {
            background-color: #b02a37;
        }

    .btn-export-excel {
        background-color: #28a745;
    }

        .btn-export-excel:hover {
            background-color: #1e7e34;
        }

    .filtro-fechas {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
        justify-content: center;
        margin-bottom: 25px;
    }

        .filtro-fechas label {
            margin-bottom: 0;
            font-weight: 600;
            color: #003366;
        }

        .filtro-fechas input[type="date"] {
            border-radius: 5px;
            border: 1px solid #ced4da;
            padding: 6px 10px;
            font-size: 0.9rem;
            width: 140px;
        }

        .filtro-fechas .btn-filtrar {
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            border: none;
            padding: 7px 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

            .filtro-fechas .btn-filtrar:hover {
                background-color: #0056b3;
            }

        .filtro-fechas .btn-limpiar {
            background-color: #6c757d;
            color: white;
            border-radius: 5px;
            border: none;
            padding: 7px 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

            .filtro-fechas .btn-limpiar:hover {
                background-color: #545b62;
            }

    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 30px;
    }
</style>

<div class="informe-container">
    <h2 class="text-center mb-4" style="color: #003366;">Informe de Torneos y Clientes</h2>

    <div class="export-buttons">
        <form asp-controller="InformeTorneos" asp-action="ExportarPdf" method="post">
            <input type="hidden" name="fechaDesde" value="@fechaDesde" />
            <input type="hidden" name="fechaHasta" value="@fechaHasta" />
            <button type="submit" class="btn-export btn-export-pdf">Exportar PDF</button>
        </form>
        <form asp-controller="InformeTorneos" asp-action="ExportarExcel" method="post">
            <input type="hidden" name="fechaDesde" value="@fechaDesde" />
            <input type="hidden" name="fechaHasta" value="@fechaHasta" />
            <button type="submit" class="btn-export btn-export-excel">Exportar Excel</button>
        </form>
    </div>

    <form method="get" asp-controller="InformeTorneos" asp-action="Index" class="filtro-fechas">
        <label for="fechaDesde">Desde:</label>
        <input type="date" id="fechaDesde" name="fechaDesde" value="@fechaDesde" />
        <label for="fechaHasta">Hasta:</label>
        <input type="date" id="fechaHasta" name="fechaHasta" value="@fechaHasta" />
        <button type="submit" class="btn-filtrar">Filtrar</button>
        <a href="@Url.Action("Index", "InformeTorneos")" class="btn-limpiar">Limpiar</a>
    </form>

    <!-- KPIs -->
    <div class="row g-4 text-white">
        <div class="col-md-3">
            <div class="card bg-primary shadow rounded-4 text-center">
                <div class="card-body">
                    <h5>Total Clientes</h5>
                    <p class="fs-3">@Model.TotalClientes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success shadow rounded-4 text-center">
                <div class="card-body">
                    <h5>Con Compras</h5>
                    <p class="fs-3">@Model.ClientesConCompras</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info shadow rounded-4 text-center">
                <div class="card-body">
                    <h5>En Torneos</h5>
                    <p class="fs-3">@Model.ClientesEnTorneos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark shadow rounded-4 text-center">
                <div class="card-body">
                    <h5>Ganadores</h5>
                    <p class="fs-3">@Model.ClientesGanadores</p>
                </div>
            </div>
        </div>
    </div>

    <hr />

    <!-- Más KPIs -->
    <div class="row text-center mb-4">
        <div class="col-md-4">
            <div class="card bg-white border-primary shadow-sm rounded-4">
                <div class="card-body">
                    <h6 class="text-primary">+ Participaciones</h6>
                    <p class="fs-5 text-dark">@Model.ClienteTopParticipaciones</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-white border-success shadow-sm rounded-4">
                <div class="card-body">
                    <h6 class="text-success">+ Ganador</h6>
                    <p class="fs-5 text-dark">@Model.ClienteTopGanador</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-white border-dark shadow-sm rounded-4">
                <div class="card-body">
                    <h6 class="text-dark">Día Más Activo</h6>
                    <p class="fs-5 text-dark">@Model.DiaMasPopular</p>
                </div>
            </div>
        </div>
    </div>

    <hr />

    <!-- Ingresos por entradas -->
    <div class="card bg-light shadow rounded-4 text-center mb-4">
        <div class="card-body">
            <h5 class="text-success">Ingresos por Entradas</h5>
            <p class="fs-3">Bs. @Model.IngresoPorEntradas.ToString("N2")</p>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row g-4">
        <div class="col-md-6 chart-container">
            <canvas id="participacionesPorDiaChart"></canvas>
        </div>
        <div class="col-md-6 chart-container">
            <canvas id="ingresosMensualesChart"></canvas>
        </div>
        <div class="col-md-6 chart-container">
            <canvas id="topParticipantesChart"></canvas>
        </div>
        <div class="col-md-6 chart-container">
            <canvas id="topGanadoresChart"></canvas>
        </div>
    </div>

   
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Datos JSON para Chart.js
        const dias = @Html.Raw(JsonSerializer.Serialize(Model.ParticipacionesPorDia.Select(x => x.Dia)));
        const datosDias = @Html.Raw(JsonSerializer.Serialize(Model.ParticipacionesPorDia.Select(x => x.Participaciones)));

        const meses = @Html.Raw(JsonSerializer.Serialize(Model.IngresosMensuales.Select(x => x.Mes)));
        const datosIngresos = @Html.Raw(JsonSerializer.Serialize(Model.IngresosMensuales.Select(x => x.TotalIngreso)));

        const topLabels = @Html.Raw(JsonSerializer.Serialize(Model.TopParticipantes.Select(x => x.NombreCompleto)));
        const topData = @Html.Raw(JsonSerializer.Serialize(Model.TopParticipantes.Select(x => x.Total)));

        const topGLabels = @Html.Raw(JsonSerializer.Serialize(Model.TopGanadores.Select(x => x.NombreCompleto)));
        const topGData = @Html.Raw(JsonSerializer.Serialize(Model.TopGanadores.Select(x => x.Total)));

        // Participaciones por Día
        new Chart(document.getElementById('participacionesPorDiaChart'), {
            type: 'bar',
            data: {
                labels: dias,
                datasets: [{
                    label: 'Participaciones por Día',
                    data: datosDias,
                    backgroundColor: '#00bfff',
                    borderColor: '#003366',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
        // Ingresos Mensuales
        new Chart(document.getElementById('ingresosMensualesChart'), {
            type: 'line',
            data: { labels: meses, datasets: [{ label: 'Bs. por Mes', data: datosIngresos, fill: false, borderColor: '#28a745', borderWidth: 2 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
        // Top Participantes
        new Chart(document.getElementById('topParticipantesChart'), {
            type: 'doughnut',
            data: { labels: topLabels, datasets: [{ label: 'Participaciones', data: topData, backgroundColor: ['#007bff','#28a745','#ffc107','#dc3545','#6f42c1'] }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
        // Top Ganadores
        new Chart(document.getElementById('topGanadoresChart'), {
            type: 'doughnut',
            data: { labels: topGLabels, datasets: [{ label: 'Ganadores', data: topGData, backgroundColor: ['#20c997','#6610f2','#fd7e14','#17a2b8','#e83e8c'] }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    </script>
}
